name: Publish Gateway Docker Image

on:
  push:
    branches:
      - 'main'
    paths:
      - 'src/any_llm/gateway/**'
      - 'alembic/**'
      - 'docker/**'
      - 'pyproject.toml'
      - '.github/workflows/gateway-docker.yml'
  release:
    types: [published]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/gateway

jobs:
  build-and-push-image:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest,enable={{is_default_branch}}
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}

      - name: Determine version for Docker build
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            VERSION="${{ github.ref_name }}"
            VERSION="${VERSION#v}"
          else
            VERSION="0.0.0.dev${{ github.run_number }}+${{ github.sha }}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Build Docker image for testing
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false # TMP FOR TESTING - REMOVE BEFORE PUSHING
          file: docker/Dockerfile
          load: true
          tags: gateway-test:${{ github.sha }}
          build-args: |
            VERSION=${{ steps.version.outputs.version }}

      - name: Run container liveness check
        run: |
          # Start PostgreSQL container
          docker run -d --name test-postgres \
            -e POSTGRES_USER=gateway \
            -e POSTGRES_PASSWORD=gateway \
            -e POSTGRES_DB=gateway \
            -p 5432:5432 \
            postgres:16-alpine

          # Wait for Postgres to be ready
          echo "Waiting for PostgreSQL to be ready..."
          for i in {1..30}; do
            if docker exec test-postgres pg_isready -U gateway > /dev/null 2>&1; then
              echo "PostgreSQL is ready"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "PostgreSQL failed to become ready"
              docker logs test-postgres
              exit 1
            fi
            sleep 1
          done

          # Create minimal gateway config
          cat > /tmp/gateway-config.yml << 'EOF'
          database_url: "postgresql://gateway:gateway@host.docker.internal:5432/gateway"
          host: "0.0.0.0"
          port: 8000
          master_key: "test-master-key"
          EOF

          # Run gateway container
          docker run -d --name test-gateway \
            --add-host=host.docker.internal:host-gateway \
            -p 8000:8000 \
            -v /tmp/gateway-config.yml:/app/config.yml \
            gateway-test:${{ github.sha }} \
            any-llm-gateway serve --config /app/config.yml

          # Wait for gateway to be healthy
          echo "Waiting for gateway to be healthy..."
          for i in {1..60}; do
            if curl -sf http://localhost:8000/health > /dev/null 2>&1; then
              echo "Gateway is responding"
              break
            fi
            if [ $i -eq 60 ]; then
              echo "Gateway failed to become healthy within 60 seconds"
              echo "=== Gateway logs ==="
              docker logs test-gateway
              exit 1
            fi
            sleep 1
          done

          # Test all health endpoints
          echo "Testing /health endpoint..."
          curl -sf http://localhost:8000/health

          echo "Testing /health/liveness endpoint..."
          curl -sf http://localhost:8000/health/liveness

          echo "Testing /health/readiness endpoint..."
          curl -sf http://localhost:8000/health/readiness

          echo "All liveness checks passed!"

      - name: Cleanup test containers
        if: always()
        run: |
          docker rm -f test-gateway test-postgres 2>/dev/null || true

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile
          push: false # TMP FOR TESTING - REMOVE BEFORE PUSHING
          platforms: linux/amd64,linux/arm64
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            VERSION=${{ steps.version.outputs.version }}
